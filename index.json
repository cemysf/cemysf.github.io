[{"content":"This was an interesting project that I\u0026rsquo;ve worked on before. I was wondering how to kickstart my inner blogging motivation for a long time, then I\u0026rsquo;ve remembered this project.\nIt was actually a side project given to me during my first working student job. At the same time I was also working on my thesis, hard times.\nProblem Think about the kitchen of a well-known fastfood restaurant chain. There is a camera mounted on top somewhere, directed towards a burger broiler machine. A broiler machine is basically an oven with a conveyor belt. Raw burger patty in, cooked burger patty out.\nProblem is: We need to count how many burgers this machine process during the day in an automatic way.\nA worker periodically puts one or multiple stack(s) of frozen burgers. Then, this machine takes the bottom one from each stack, with a metal rod on the conveyor belt. Think that like drawing a card from a deck, but in this case the deck is a stack of burgers and finger is the metal rod, and it takes the card from bottom of the deck. See Video 1 for example:\nYour browser doesn't support embedded videos, but don't worry, you can download it and watch it with your favorite video player! Video 1: Problem definition. Notice the moving metal rod of conveyor into the broiler.\nAs the Video 1 shows, speed of this metal rod is not constant, it varies according to the number of orders. Left and right trays are independent, let\u0026rsquo;s say we count only the left side for now.\nWith each full upwards motion of the metal rod (i.e. one conveyor cycle), machine takes one burger from each stack, therefore we can formulate the problem as following:\ncount = 0 for each conveyor cycle: count += number of burger stacks To solve this problem, we need two things to do: detect each conveyor cycle and detect number of burger patty stacks.\nMetal rod detection In order to detect a full motion of metal rod, first we need to know where it is in each frame. That\u0026rsquo;s why we need a \u0026lsquo;metal rod detector\u0026rsquo; first.\nFor this, I\u0026rsquo;ve experimented with a lot of techniques, like template matching, sobel filter, etc..\nI\u0026rsquo;ve ended up with the following pipeline with a customized FFT filter + OTSU thresholder to estimate the pixels belonging to the metal rod.\nFigure 1: Metal rod location detector pipeline\nIn order to get the vertical location of metal rod, I\u0026rsquo;ve accumulated the number of white pixels in horizontal bins, then convoluted that with a basic gaussian filter for noise reduction. At the end, the location of the max value (argmax) means the vertical location of the metal rod.\nConveyor cycle detection Now, if we plot the location of the metal rod over time, we can see a pattern. Figure 2 shows the metal rod location/time of the empty tray. Don\u0026rsquo;t worry about the decreasing way of the signal, it\u0026rsquo;s because row numbers grow through the lower parts of the image. Figure 2: Metal rod location over time\nThis signal becomes much more noisy when there is some stack of burgers, therefore I\u0026rsquo;ve manually adjusted the metal rod detector to operate only on the lower side of tray, and also applied median filter to further reduce the noise down. The resulting signal looks something like this in Figure 3:\nFigure 3: Metal rod location over time, after some adjustments\nIt\u0026rsquo;s clear that a full downward cycle of metal rod in the signal = metal rod goes into the machine = machine takes some patties inside. To detect the downwards trend of metal rod location, I\u0026rsquo;ve applied cross correlation with a down sawtooth wave, which results the signal in Figure 4.\nWith this, now we can detect each conveyor cycle, since each peak represents one cycle of the conveyor metal\nFigure 4: Cross-correlated metal rod signal, each peak means one full cyle of metal rod\nBurger patty stack detection We need to detect number of patty stacks, because we increase the total count by this value for each conveyor cycle. This was again some trial and error with various methods that I don\u0026rsquo;t remember right now. Ended up with this following pipeline in Figure 5. I\u0026rsquo;ve used OpenCV\u0026rsquo;s already existing blob detector at the end.\nFigure 5: Burger patty stack count detection pipeline\nFinal result Patty stack detector runs for every frame as well. After some median filtering of this signal, and combining it with the conveyor cycle detection signal, we can now have the complete burger patty counter. Check out the Video 2 for the final result.\nYour browser doesn't support embedded videos, but don't worry, you can download it and watch it with your favorite video player! Video 2: End result\nIn the Video 2, bottom left show the patty stack counter. Bottom right is the metal rod location detector. Top right shows the combined detectors, where red signal is the patty stack count over time, blue signal is the conveyor cycle detector. Yellow signal is the total number of patties inserted into the machine.\nIn each peak of the blue signal, total count is incremented by the current value of patty stack count. So that\u0026rsquo;s one way to count number of pattties inserted into a broiler machine.\nConclusion This was a really interesting project for me, I\u0026rsquo;ve learned a lot during and had a lot of fun. Unfortunately I cannot share the code of this - if I were able to, it wouldn\u0026rsquo;t be much useful anyway, because it was such a mess. But, I can say that I\u0026rsquo;ve used python and openCV. I\u0026rsquo;ve created the detectors as separate threads and also created another thread for combining the information.\nFeel free to contact me about the details, or about any questions\n","permalink":"https://cemysf.github.io/posts/counting-meatball-patties/","summary":"\u003cp\u003eThis was an interesting project that I\u0026rsquo;ve worked on before. I was wondering how to kickstart my inner blogging motivation for a long time, then I\u0026rsquo;ve remembered this project.\u003c/p\u003e\n\u003cp\u003eIt was actually a side project given to me during my first working student job. At the same time I was also working on my thesis, hard times.\u003c/p\u003e\n\u003ch1 id=\"problem\"\u003eProblem\u003c/h1\u003e\n\u003cp\u003eThink about the kitchen of a well-known fastfood restaurant chain. There is a camera mounted on top somewhere, directed towards a burger broiler machine. A broiler machine is basically an oven with a conveyor belt. Raw burger patty in, cooked burger patty out.\u003c/p\u003e","title":"A machine vision project: Counting number of burger patties with OpenCV"}]